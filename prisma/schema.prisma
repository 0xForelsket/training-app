// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Shift {
  DAY
  NIGHT
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("VIEWER") // TRAINER, ADMIN, VIEWER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  validatedTrainings TrainingRecord[]
  auditLogs AuditLog[]
  trainingAssignments TrainingAssignment[]
  uploadLogs UploadLog[]
  employeeNotes EmployeeNote[]
  skillRevisions SkillRevision[]
}

model Employee {
  employeeNumber String           @id
  name          String
  department    String? // e.g., "Assembly", "Logistics"
  shift         Shift            @default(DAY)
  dateHired     DateTime
  photoUrl      String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  trainings     TrainingRecord[]
  assignments   TrainingAssignment[]
  notes         EmployeeNote[]
}

model Skill {
  code        String           @id
  name        String
  project     String?
  description String?
  documentUrl String?
  validityMonths Int?
  recertReminderDays Int?
  currentRevisionId String? @unique
  currentRevisionNumber Int     @default(1)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  trainings   TrainingRecord[]
  assignments TrainingAssignment[]
  revisions   SkillRevision[]
  currentRevision SkillRevision? @relation("CurrentSkillRevision", fields: [currentRevisionId], references: [id])
}

model TrainingAssignment {
  id               String            @id @default(cuid())
  employeeId   String
  skillId        String
  assignedById     String?
  targetLevel      Int
  dueDate          DateTime
  status           AssignmentStatus  @default(PENDING)
  notes            String?
  lastReminderSentAt DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  employee         Employee          @relation(fields: [employeeId], references: [employeeNumber])
  skill            Skill             @relation(fields: [skillId], references: [code])
  assignedBy       User?             @relation(fields: [assignedById], references: [id])

  @@index([employeeId])
  @@index([skillId])
}

model TrainingRecord {
  id            String   @id @default(cuid())
  employeeId    String
  skillId       String
  skillRevisionId String?
  validatorId   String // User ID of the trainer
  level         Int      @default(1) // 1-4 TPS Scale
  dateValidated DateTime @default(now())
  validatorNotes String?
  evidenceUrl    String?
  
  employee      Employee @relation(fields: [employeeId], references: [employeeNumber])
  skill         Skill    @relation(fields: [skillId], references: [code])
  skillRevision SkillRevision? @relation(fields: [skillRevisionId], references: [id])
  validator     User     @relation(fields: [validatorId], references: [id])
  
  @@unique([employeeId, skillId])
}

model SkillRevision {
  id                 String   @id @default(cuid())
  skillId            String
  revisionNumber     Int
  name               String
  description        String?
  documentUrl        String?
  validityMonths     Int?
  recertReminderDays Int?
  effectiveDate      DateTime @default(now())
  createdAt          DateTime @default(now())
  createdById        String?

  skill              Skill    @relation(fields: [skillId], references: [code])
  currentFor         Skill?   @relation("CurrentSkillRevision")
  createdBy          User?    @relation(fields: [createdById], references: [id])
  trainings          TrainingRecord[]

  @@unique([skillId, revisionNumber])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // e.g., "CREATE_USER", "VALIDATE_SKILL"
  entityId   String?  // ID of the affected object
  entityType String   // e.g., "User", "Skill", "TrainingRecord"
  userId     String   // Who performed the action
  user       User     @relation(fields: [userId], references: [id])
  details    String?  // JSON string or text description
  createdAt  DateTime @default(now())
}

model UploadLog {
  id           String   @id @default(cuid())
  type         String
  status       String
  totalRows    Int
  successCount Int
  failureCount Int
  details      String?
  createdAt    DateTime @default(now())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id])

  @@index([type])
  @@index([createdAt])
}

model EmployeeNote {
  id         String   @id @default(cuid())
  employeeId String
  authorId   String?
  content    String
  createdAt  DateTime @default(now())

  employee   Employee @relation(fields: [employeeId], references: [employeeNumber])
  author     User?    @relation(fields: [authorId], references: [id])

  @@index([employeeId])
  @@index([createdAt])
}
